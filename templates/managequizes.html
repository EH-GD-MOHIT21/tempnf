{% load static %} {% load index %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Quizes @ NestedForm</title>
    <link rel="stylesheet" href="{% static 'creator.css' %}">
    <style>
    button{
        padding: 6px 10px;
        color: white;
        background: crimson;
        border: 1px solid gray;
        border-radius: 4px;
        font-size: 15px;
        cursor: pointer;
        }
    li:hover{
        text-decoration: underline;
        color: crimson;
    }
    </style>
</head>

<body>
    <div class="container">
        {% for id,res in data %}
        <div class="child1">
            <div class="constpart">
                <p>Quiz Id: {{id}}</p>
                <button style="background:green;text-align:center;display:block;margin: 10px auto;" type="button" onclick="createcsv('{{id}}')">Create Csv</button>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3>Responses: <span id="tr-{{forloop.counter0}}">{{res}}</span></h3>
                    <button type="button" onclick="mohitfuncdel('{{id}}',this);">Delete Quiz</button>
                </div>
            </div>
            <div class="wrapperconstpart" style="overflow-x: auto;max-height:75vh;">
                {% for data in resdata|index:forloop.counter0 %}
                <div class="childconstpart">
                    <li onclick="delresp('{{id}}','{{data}}',this,'tr-{{forloop.parentloop.counter0}}')" style="cursor:pointer;">{{data}}</li>
                    <a href="showquizresponses/{{id}}/filter?email={{data}}">View Response</a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    <h3 style="text-align:center;color:crimson;margin:20px auto;">To manage forms <a href="/creatoraccesspage">click here</a></h3>
    <h4>{{mail}} is recorded while creating Form.</h4>
</body>
<script>
    async function mohitfuncdel(id, btn) {
        a = prompt("Type delete (small letters) for confirm delete");
        if(a!="delete")
            return;
        let response = await fetch('/deletequiz', {
            credentials: 'include',
            method: 'POST',
            mode: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "quiz_id": id,
                "email": "{{request.user.email}}"
            })
        })
        if (response.ok) {
            let json = await response.json();
            let message = json["message"]
            if (message == "success") {
                btn.parentElement.parentElement.parentElement.remove()
                    //qtotalearned
            }
            alert(message);
        } else {
            alert("HTTP-Error: " + response.status);
        }
    }

    async function createcsv(id){
        let response = await fetch('/createcsv', {
            credentials: 'include',
            method: 'POST',
            mode: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "quiz_id": id,
                "email": "{{request.user.email}}"
            })
        })
        if (response.ok) {
            let json = await response.json();
            let message = json["message"]
            if (message == "success") {
                window.location.href = json["path"];
            }else{
                alert(message);
            }
        } else {
            alert("HTTP-Error: " + response.status);
        }
    }

    async function delresp(id,email,elm,headid){
        var inp = prompt("Type delete (small letters) to delete correspondes response")
        if(inp=='delete'){
        let response = await fetch('/deluserresponse', {
            credentials: 'include',
            method: 'POST',
            mode: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "quiz_id": id,
                "email": email
            })
        })
        if (response.ok) {
            let json = await response.json();
            let message = json["message"]
            if (message == "success") {
                var temp = parseInt(document.getElementById(headid).textContent)
                temp -= 1
                document.getElementById(headid).textContent = temp;
                elm.parentElement.remove()
            }else{
                alert(message);
            }
        } else {
            alert("HTTP-Error: " + response.status);
        }
        }

    }
</script>

</html>